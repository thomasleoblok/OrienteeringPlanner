const accessToken = 'pk.eyJ1IjoidGhvbWFzYmxvazk4IiwiYSI6ImNraWsxcWt0azAzenEyc3FxdXYxZmd0b3cifQ.fGLxZGyyR69lfpCepU0l4g';
const svgControl = '<svg id="svg" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="400" height="400.5194805194805" viewBox="0, 0, 400,400.5194805194805"><g id="svgg"><path id="path0" d="M0.000 200.200 L 0.000 400.400 200.000 400.400 L 400.000 400.400 400.000 200.200 L 400.000 0.000 200.000 0.000 L 0.000 0.000 0.000 200.200 M398.400 199.800 C 398.400 309.030,398.355 398.400,398.300 398.400 C 398.245 398.400,308.830 309.030,199.600 199.800 L 1.000 1.200 199.700 1.200 L 398.400 1.200 398.400 199.800 M199.126 201.000 L 396.753 398.800 198.777 398.800 L 0.800 398.800 0.800 201.000 C 0.800 88.341,0.951 3.200,1.150 3.200 C 1.342 3.200,90.432 92.210,199.126 201.000 " stroke="none" fill="#343332" fill-rule="evenodd"></path><path id="path1" d="M1.771 1.500 C 1.938 1.665,91.248 91.041,200.237 200.112 L 398.400 398.425 398.400 199.812 L 398.400 1.200 199.933 1.200 C 90.777 1.200,1.603 1.335,1.771 1.500 " stroke="none" fill="#fbfbfb" fill-rule="evenodd"></path><path id="path2" d="M1.212 200.713 C 1.202 358.204,1.301 398.063,1.700 398.215 C 1.975 398.319,90.732 398.359,198.937 398.302 L 395.673 398.200 198.449 200.800 L 1.224 3.400 1.212 200.713 " stroke="none" fill="#fc7c04" fill-rule="evenodd"></path><path id="path3" d="M29.800 30.000 C 45.639 45.840,58.688 58.800,58.798 58.800 C 58.908 58.800,46.039 45.840,30.200 30.000 C 14.361 14.160,1.312 1.200,1.202 1.200 C 1.092 1.200,13.961 14.160,29.800 30.000 M0.899 201.100 L 0.999 399.000 1.199 201.274 L 1.400 3.547 127.322 129.574 C 196.579 198.888,253.369 255.600,253.522 255.600 C 253.675 255.600,197.010 198.810,127.600 129.400 C 58.190 59.990,1.265 3.200,1.100 3.200 C 0.935 3.200,0.845 92.255,0.899 201.100 M60.600 60.800 C 61.459 61.680,62.252 62.400,62.362 62.400 C 62.472 62.400,61.859 61.680,61.000 60.800 C 60.141 59.920,59.348 59.200,59.238 59.200 C 59.128 59.200,59.741 59.920,60.600 60.800 M65.800 66.000 C 66.659 66.880,67.452 67.600,67.562 67.600 C 67.672 67.600,67.059 66.880,66.200 66.000 C 65.341 65.120,64.548 64.400,64.438 64.400 C 64.328 64.400,64.941 65.120,65.800 66.000 M69.400 69.600 C 70.259 70.480,71.052 71.200,71.162 71.200 C 71.272 71.200,70.659 70.480,69.800 69.600 C 68.941 68.720,68.148 68.000,68.038 68.000 C 67.928 68.000,68.541 68.720,69.400 69.600 M73.800 74.000 C 75.106 75.320,76.265 76.400,76.375 76.400 C 76.485 76.400,75.506 75.320,74.200 74.000 C 72.894 72.680,71.735 71.600,71.625 71.600 C 71.515 71.600,72.494 72.680,73.800 74.000 M78.200 78.400 C 79.059 79.280,79.852 80.000,79.962 80.000 C 80.072 80.000,79.459 79.280,78.600 78.400 C 77.741 77.520,76.948 76.800,76.838 76.800 C 76.728 76.800,77.341 77.520,78.200 78.400 M85.200 85.400 C 85.946 86.170,86.647 86.800,86.757 86.800 C 86.867 86.800,86.346 86.170,85.600 85.400 C 84.854 84.630,84.153 84.000,84.043 84.000 C 83.933 84.000,84.454 84.630,85.200 85.400 M95.400 95.600 C 96.259 96.480,97.052 97.200,97.162 97.200 C 97.272 97.200,96.659 96.480,95.800 95.600 C 94.941 94.720,94.148 94.000,94.038 94.000 C 93.928 94.000,94.541 94.720,95.400 95.600 M99.000 99.200 C 99.859 100.080,100.652 100.800,100.762 100.800 C 100.872 100.800,100.259 100.080,99.400 99.200 C 98.541 98.320,97.748 97.600,97.638 97.600 C 97.528 97.600,98.141 98.320,99.000 99.200 M254.000 256.111 C 254.000 256.510,277.618 280.116,277.817 279.916 C 277.901 279.833,272.576 274.373,265.985 267.785 C 259.393 261.196,254.000 255.943,254.000 256.111 M278.400 280.539 C 278.400 280.983,281.173 283.760,281.395 283.538 C 281.500 283.434,280.869 282.648,279.993 281.793 C 279.117 280.937,278.400 280.373,278.400 280.539 M283.600 285.739 C 283.600 286.183,286.373 288.960,286.595 288.738 C 286.700 288.634,286.069 287.848,285.193 286.993 C 284.317 286.137,283.600 285.573,283.600 285.739 M287.200 289.352 C 287.200 289.782,289.595 292.138,289.812 291.921 C 289.909 291.825,289.361 291.137,288.594 290.394 C 287.827 289.651,287.200 289.182,287.200 289.352 M290.800 292.952 C 290.800 293.382,293.195 295.738,293.412 295.521 C 293.509 295.425,292.961 294.737,292.194 293.994 C 291.427 293.251,290.800 292.782,290.800 292.952 M297.600 300.000 C 297.835 300.440,298.230 300.800,298.476 300.800 C 298.722 300.800,298.598 300.440,298.200 300.000 C 297.802 299.560,297.408 299.200,297.324 299.200 C 297.240 299.200,297.365 299.560,297.600 300.000 M301.200 303.600 C 301.435 304.040,301.830 304.400,302.076 304.400 C 302.322 304.400,302.198 304.040,301.800 303.600 C 301.402 303.160,301.008 302.800,300.924 302.800 C 300.840 302.800,300.965 303.160,301.200 303.600 M302.800 305.102 C 302.800 305.322,303.070 305.726,303.400 306.000 C 303.735 306.278,304.000 306.321,304.000 306.098 C 304.000 305.878,303.730 305.474,303.400 305.200 C 303.065 304.922,302.800 304.879,302.800 305.102 M304.400 306.578 C 304.400 307.018,307.194 309.739,307.417 309.517 C 307.509 309.424,306.869 308.648,305.993 307.793 C 305.117 306.937,304.400 306.391,304.400 306.578 M308.000 310.302 C 308.000 310.522,308.270 310.926,308.600 311.200 C 308.935 311.478,309.200 311.521,309.200 311.298 C 309.200 311.078,308.930 310.674,308.600 310.400 C 308.265 310.122,308.000 310.079,308.000 310.302 M309.600 311.889 C 309.600 312.392,310.743 313.390,311.012 313.121 C 311.118 313.015,310.844 312.602,310.402 312.202 C 309.961 311.803,309.600 311.662,309.600 311.889 M314.800 317.089 C 314.800 317.592,315.943 318.590,316.212 318.321 C 316.318 318.215,316.044 317.802,315.602 317.402 C 315.161 317.003,314.800 316.862,314.800 317.089 M318.400 320.702 C 318.400 320.922,318.670 321.326,319.000 321.600 C 319.335 321.878,319.600 321.921,319.600 321.698 C 319.600 321.478,319.330 321.074,319.000 320.800 C 318.665 320.522,318.400 320.479,318.400 320.702 M378.795 381.330 C 382.423 384.999,385.476 388.000,385.580 388.000 C 385.865 388.000,375.205 377.172,373.600 375.830 C 372.830 375.187,375.168 377.662,378.795 381.330 M387.400 390.000 C 388.259 390.880,389.052 391.600,389.162 391.600 C 389.272 391.600,388.659 390.880,387.800 390.000 C 386.941 389.120,386.148 388.400,386.038 388.400 C 385.928 388.400,386.541 389.120,387.400 390.000 M392.600 395.200 C 393.459 396.080,394.252 396.800,394.362 396.800 C 394.472 396.800,393.859 396.080,393.000 395.200 C 392.141 394.320,391.348 393.600,391.238 393.600 C 391.128 393.600,391.741 394.320,392.600 395.200 " stroke="none" fill="#a75304" fill-rule="evenodd"></path><path id="path4" d="M199.000 199.200 C 199.859 200.080,200.652 200.800,200.762 200.800 C 200.872 200.800,200.259 200.080,199.400 199.200 C 198.541 198.320,197.748 197.600,197.638 197.600 C 197.528 197.600,198.141 198.320,199.000 199.200 M212.800 213.000 C 219.287 219.490,224.685 224.800,224.795 224.800 C 224.905 224.800,219.687 219.490,213.200 213.000 C 206.713 206.510,201.315 201.200,201.205 201.200 C 201.095 201.200,206.313 206.510,212.800 213.000 M231.000 231.200 C 234.294 234.500,237.080 237.200,237.190 237.200 C 237.300 237.200,234.694 234.500,231.400 231.200 C 228.106 227.900,225.320 225.200,225.210 225.200 C 225.100 225.200,227.706 227.900,231.000 231.200 M239.400 239.600 C 240.483 240.700,241.460 241.600,241.570 241.600 C 241.680 241.600,240.883 240.700,239.800 239.600 C 238.717 238.500,237.740 237.600,237.630 237.600 C 237.520 237.600,238.317 238.500,239.400 239.600 M248.600 248.800 C 249.459 249.680,250.252 250.400,250.362 250.400 C 250.472 250.400,249.859 249.680,249.000 248.800 C 248.141 247.920,247.348 247.200,247.238 247.200 C 247.128 247.200,247.741 247.920,248.600 248.800 M253.000 253.200 C 254.306 254.520,255.465 255.600,255.575 255.600 C 255.685 255.600,254.706 254.520,253.400 253.200 C 252.094 251.880,250.935 250.800,250.825 250.800 C 250.715 250.800,251.694 251.880,253.000 253.200 M259.000 259.200 C 260.750 260.960,262.271 262.400,262.381 262.400 C 262.491 262.400,261.150 260.960,259.400 259.200 C 257.650 257.440,256.129 256.000,256.019 256.000 C 255.909 256.000,257.250 257.440,259.000 259.200 M265.000 265.200 C 266.306 266.520,267.465 267.600,267.575 267.600 C 267.685 267.600,266.706 266.520,265.400 265.200 C 264.094 263.880,262.935 262.800,262.825 262.800 C 262.715 262.800,263.694 263.880,265.000 265.200 M274.600 274.800 C 275.459 275.680,276.252 276.400,276.362 276.400 C 276.472 276.400,275.859 275.680,275.000 274.800 C 274.141 273.920,273.348 273.200,273.238 273.200 C 273.128 273.200,273.741 273.920,274.600 274.800 M278.200 278.400 C 279.059 279.280,279.852 280.000,279.962 280.000 C 280.072 280.000,279.459 279.280,278.600 278.400 C 277.741 277.520,276.948 276.800,276.838 276.800 C 276.728 276.800,277.341 277.520,278.200 278.400 M1.200 398.500 C 1.200 398.665,90.165 398.755,198.900 398.701 C 307.635 398.647,364.380 398.557,325.000 398.501 C 132.559 398.230,1.200 398.229,1.200 398.500 " stroke="none" fill="#f49239" fill-rule="evenodd"></path></g></svg>'

function RenderMapboxComponent(upcomingRuns) {
    var elementExists = document.getElementById("map");

    if (elementExists) {
        var upcomingRunsGeoJson = upcomingRunsToGeoJson(upcomingRuns);

        var map = new mapboxgl.Map({
            accessToken: accessToken,
            container: 'map',
            style: 'mapbox://styles/thomasblok98/ckl6xv0gg19mk17s11nhdraet',
            zoom: getZoom(),
            center: getLngLat()
        });

        map.on('load', function () {
            map.loadImage(
                '/images/controlPoint.png',
                function (error, image) {
                    if (error) throw error;
                    map.addImage('controlPoint', image);
                    // Add a new source from our GeoJSON data and
                    // set the 'cluster' option to true. GL-JS will
                    // add the point_count property to your source data.
                    map.addSource('earthquakes', {
                        type: 'geojson',
                        // Point to GeoJSON data. This example visualizes all M1.0+ earthquakes
                        // from 12/22/15 to 1/21/16 as logged by USGS' Earthquake hazards program.
                        data:
                            upcomingRunsGeoJson,
                        cluster: true,
                        clusterMaxZoom: 14, // Max zoom to cluster points on
                        clusterRadius: 50 // Radius of each cluster when clustering points (defaults to 50)
                    });

                    map.addLayer({
                        id: 'clusters',
                        type: 'circle',
                        source: 'earthquakes',
                        filter: ['has', 'point_count'],
                        paint: {
                            // Use step expressions (https://docs.mapbox.com/mapbox-gl-js/style-spec/#expressions-step)
                            // with three steps to implement three types of circles:
                            //   * Blue, 20px circles when point count is less than 100
                            //   * Yellow, 30px circles when point count is between 100 and 750
                            //   * Pink, 40px circles when point count is greater than or equal to 750
                            'circle-color': [
                                'step',
                                ['get', 'point_count'],
                                '#51bbd6',
                                100,
                                '#f1f075',
                                750,
                                '#f28cb1'
                            ],
                            'circle-radius': [
                                'step',
                                ['get', 'point_count'],
                                20,
                                100,
                                30,
                                750,
                                40
                            ]
                        }
                    });

                    map.addLayer({
                        id: 'cluster-count',
                        type: 'symbol',
                        source: 'earthquakes',
                        filter: ['has', 'point_count'],
                        layout: {
                            'text-field': '{point_count_abbreviated}',
                            'text-font': ['DIN Offc Pro Medium', 'Arial Unicode MS Bold'],
                            'text-size': 12
                        }
                    });

                    map.addLayer({
                        id: 'unclustered-point',
                        type: 'symbol',
                        source: 'earthquakes',
                        filter: ['!', ['has', 'point_count']],
                        layout: {
                            'icon-image': 'controlPoint',
                            'icon-size': 0.8
                        }
                    });

                    // inspect a cluster on click
                    map.on('click', 'clusters', function (e) {
                        var features = map.queryRenderedFeatures(e.point, {
                            layers: ['clusters']
                        });
                        var clusterId = features[0].properties.cluster_id;
                        map.getSource('earthquakes').getClusterExpansionZoom(
                            clusterId,
                            function (err, zoom) {
                                if (err) return;

                                map.easeTo({
                                    center: features[0].geometry.coordinates,
                                    zoom: zoom
                                });
                            }
                        );
                    });

                    // When a click event occurs on a feature in
                    // the unclustered-point layer, open a popup at
                    // the location of the feature, with
                    // description HTML from its properties.
                    map.on('click', 'unclustered-point', function (e) {
                        var coordinates = e.features[0].geometry.coordinates.slice();
                        var name = e.features[0].properties.name;
                        var id = e.features[0].properties.id;

                        var start = e.features[0].properties.startDateTime;
                        var startDateTimeObject = new Date(start);
                        var startYear = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(startDateTimeObject);
                        var startMonth = new Intl.DateTimeFormat('en', { month: 'short' }).format(startDateTimeObject);
                        var startDay = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(startDateTimeObject);
                        var startTime = ("0" + startDateTimeObject.getHours()).slice(-2) + ":" +
                                        ("0" + startDateTimeObject.getMinutes()).slice(-2);

                        var startDateTimeString = `${startDay}-${startMonth}-${startYear} ${startTime}`;

                        var end = e.features[0].properties.endDateTime;
                        var endDateTimeObject = new Date(end);

                        var endYear = new Intl.DateTimeFormat('en', { year: 'numeric' }).format(endDateTimeObject);
                        var endMonth = new Intl.DateTimeFormat('en', { month: 'short' }).format(endDateTimeObject);
                        var endDay = new Intl.DateTimeFormat('en', { day: '2-digit' }).format(endDateTimeObject);
                        var endTime = ("0" + endDateTimeObject.getHours()).slice(-2) + ":" +
                                      ("0" + endDateTimeObject.getMinutes()).slice(-2);

                        var endDateTimeString = `${endDay}-${endMonth}-${endYear} ${endTime}`;

                        var gotoLink = e.features[0].properties.gotoLink;

                        // Ensure that if the map is zoomed out such that
                        // multiple copies of the feature are visible, the
                        // popup appears over the copy being pointed to.
                        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                            coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                        }

                        new mapboxgl.Popup()
                            .setLngLat(coordinates)
                            .setHTML(
                                '<div class="popUpBox"><b>' + name + '</b><br>Starts at: ' + startDateTimeString + '<br>Ends at: ' + endDateTimeString + '<br>' +
                                '<a onclick="jsFunctions.UpdateCount(' + id + ')" href="' + gotoLink + '" target="_blank">Check it out!</a></div>'
                            )
                            .addTo(map);
                    });

                    map.on('mouseenter', 'clusters', function () {
                        map.getCanvas().style.cursor = 'pointer';
                    });
                    map.on('mouseleave', 'clusters', function () {
                        map.getCanvas().style.cursor = '';
                    });
                });
        });
    }
}

function upcomingRunsToGeoJson(upcomingRuns) {
    var geojson = {};
    geojson['type'] = 'FeatureCollection';
    geojson['features'] = [];

    for (var i = 0; i < upcomingRuns.length; i++) {
        var newFeature = {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [parseFloat(upcomingRuns[i].lng), parseFloat(upcomingRuns[i].lat)]
            },
            "properties": {
                "id": upcomingRuns[i].id,
                "name": upcomingRuns[i].name,
                "lat": upcomingRuns[i].lat,
                "lng": upcomingRuns[i].lng,
                "startDateTime": upcomingRuns[i].startDateTime,
                "endDateTime": upcomingRuns[i].endDateTime,
                "gotoLink": upcomingRuns[i].gotoLink,
                "clubId": upcomingRuns[i].clubId,
            }
        }
        geojson['features'].push(newFeature);
    }

    return geojson;
}


function getWidth() {
    return document.body.clientWidth;
}

function getZoom() {
    if (getWidth() < 500)
        return 4.6;
    else if (getWidth() < 550)
        return 4.8;
    else if (getWidth() < 570)
        return 5.0;
    else
        return 6.5;
}

function getLngLat() {
    if (getWidth() < 500)
        return [10.9544113, 55.335166];
    else if (getWidth() < 550)
        return [10.9544113, 55.335166];
    else if (getWidth() < 570)
        return [10.9544113, 55.335166];
    else
        return [10.5509733, 56.41];
}

window.jsFunctions = {
    UpdateCount: function (id) {
        fetch('api/runs/UpdateCount/' + id).then(response => {

        });
    }
};